<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ Excel-—Ñ–∞–π–ª–æ–≤</title>
    
    <!-- CDN –¥–ª—è XLSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- CDN –¥–ª—è FileSaver -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f5f7fa;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .header {
            background-color: #4a5568;
            color: white;
            padding: 20px 30px;
            font-size: 20px;
            font-weight: 600;
        }
        .file-inputs {
            padding: 30px;
            border-bottom: 2px solid #e2e8f0;
        }
        .file-input-group {
            margin-bottom: 20px;
        }
        .file-input-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2d3748;
        }
        .file-input-group input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #cbd5e0;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }
        .file-input-group input[type="file"]:hover {
            border-color: #3182ce;
        }
        .file-name {
            margin-top: 5px;
            font-size: 12px;
            color: #718096;
            font-style: italic;
        }
        .button-container {
            text-align: center;
            margin-top: 20px;
        }
        button {
            background-color: #3182ce;
            color: white;
            border: none;
            padding: 12px 40px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover:not(:disabled) {
            background-color: #2c5aa0;
        }
        button:disabled {
            background-color: #cbd5e0;
            cursor: not-allowed;
        }
        .loading {
            text-align: center;
            padding: 30px;
            font-size: 16px;
            color: #4a5568;
        }
        .error {
            text-align: center;
            padding: 20px;
            color: #e53e3e;
            font-size: 14px;
            background-color: #fff5f5;
            border: 1px solid #fc8181;
            border-radius: 4px;
            margin: 20px 30px;
        }
        .success {
            text-align: center;
            padding: 20px;
            color: #38a169;
            font-size: 14px;
            background-color: #f0fff4;
            border: 1px solid #68d391;
            border-radius: 4px;
            margin: 20px 30px;
        }
        .table-container {
            max-height: 500px;
            overflow: auto;
            margin: 20px 30px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #4a5568;
            color: white;
        }
        th {
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #2d3748;
            white-space: nowrap;
        }
        td {
            padding: 10px 8px;
            border-bottom: 1px solid #e2e8f0;
        }
        tbody tr:nth-child(even) {
            background-color: #f7fafc;
        }
        tbody tr:nth-child(odd) {
            background-color: #ffffff;
        }
        tbody tr:hover {
            background-color: #edf2f7;
        }
        .text-right {
            text-align: right;
        }
        .download-section {
            padding: 20px 30px 30px;
            text-align: center;
        }
        #downloadBtn {
            display: none;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            üìä –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ Excel-—Ñ–∞–π–ª–æ–≤
        </div>
        
        <div class="file-inputs">
            <div class="file-input-group">
                <label for="reportFile">üìÑ –û—Ç—á—ë—Ç –ø–æ –û–° –Ω–∞ –æ—Ç–≥—Ä—É–∑–∫—É (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π):</label>
                <input type="file" id="reportFile" accept=".xlsx, .xls">
                <div class="file-name" id="reportFileName"></div>
            </div>
            
            <div class="file-input-group">
                <label for="scheduleFile">üìã –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–æ–≤ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π):</label>
                <input type="file" id="scheduleFile" accept=".xlsx, .xls">
                <div class="file-name" id="scheduleFileName"></div>
            </div>
            
            <div class="file-input-group">
                <label for="posmFile">üì¶ POSM (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                <input type="file" id="posmFile" accept=".xlsx, .xls">
                <div class="file-name" id="posmFileName"></div>
            </div>
            
            <div class="button-container">
                <button id="processBtn" onclick="processFiles()" disabled>–û–±—Ä–∞–±–æ—Ç–∞—Ç—å</button>
            </div>
        </div>
        
        <div id="loadingMessage" class="loading hidden">‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        <div id="errorMessage" class="error hidden"></div>
        <div id="successMessage" class="success hidden"></div>
        
        <div id="tableContainer" class="table-container hidden">
            <table id="resultTable">
                <thead>
                    <tr>
                        <th>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç/‚Ññ –∑–∞–∫–∞–∑–∞</th>
                        <th class="text-right">‚Ññ –º–∞–≥–∞–∑–∏–Ω–∞</th>
                        <th>–ë—Ä–µ–Ω–¥/–¢–¶</th>
                        <th>–ú–µ—Å—Ç–æ</th>
                        <th class="text-right">–ö–æ–ª-–≤–æ –∫–æ—Ä</th>
                        <th class="text-right">–ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –ë—Ä–µ–Ω–¥–∞ –≤ –¢–°</th>
                        <th class="text-right">–ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –≤–Ω—É—Ç—Ä–∏ –ë—Ä–µ–Ω–¥–∞</th>
                        <th>–ö–æ–º–º–µ–Ω—Ç.</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
        
        <div class="download-section">
            <button id="downloadBtn" onclick="exportToExcel()">–°–∫–∞—á–∞—Ç—å Excel</button>
        </div>
    </div>
 
    <script>
        let processedData = [];
        let reportFileData = null;
        let scheduleFileData = null;
        let posmFileData = null;
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤
        document.getElementById('reportFile').addEventListener('change', function(e) {
            reportFileData = e.target.files[0];
            document.getElementById('reportFileName').textContent = reportFileData ? reportFileData.name : '';
            checkRequiredFiles();
        });
        document.getElementById('scheduleFile').addEventListener('change', function(e) {
            scheduleFileData = e.target.files[0];
            document.getElementById('scheduleFileName').textContent = scheduleFileData ? scheduleFileData.name : '';
            checkRequiredFiles();
        });
        document.getElementById('posmFile').addEventListener('change', function(e) {
            posmFileData = e.target.files[0];
            document.getElementById('posmFileName').textContent = posmFileData ? posmFileData.name : '';
        });
        function checkRequiredFiles() {
            const processBtn = document.getElementById('processBtn');
            processBtn.disabled = !(reportFileData && scheduleFileData);
        }
        // –§—É–Ω–∫—Ü–∏—è —á—Ç–µ–Ω–∏—è Excel —Ñ–∞–π–ª–∞
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { defval: '' });
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = function(error) {
                    reject(error);
                };
                reader.readAsArrayBuffer(file);
            });
        }
        // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞
        function filterReport(data) {
            return data.filter(row => {
                const orderType = (row['–¢–∏–ø –∑–∞–∫–∞–∑–∞'] || '').toString().toUpperCase();
                const storeNumber = (row['–ù–æ–º–µ—Ä –º–∞–≥–∞–∑–∏–Ω–∞'] || '').toString();
                
                // –ò—Å–∫–ª—é—á–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ —Å MOP
                if (orderType.includes('MOP')) return false;
                
                // –ò—Å–∫–ª—é—á–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ —Å POSM
                if (orderType.includes('POSM')) return false;
                
                // –ò—Å–∫–ª—é—á–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ —Å –Ω–µ—Ü–∏—Ñ—Ä–æ–≤—ã–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏ –≤ –Ω–æ–º–µ—Ä–µ –º–∞–≥–∞–∑–∏–Ω–∞
                if (!/^\d+$/.test(storeNumber)) return false;
                
                return true;
            });
        }
        // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
        function filterSchedule(data) {
            return data.filter(row => {
                const tempCancel = (row['–í–†–ï–ú–ï–ù–ù–ê–Ø –û–¢–ú–ï–ù–ê'] || '').toString().toUpperCase();
                return tempCancel !== 'X';
            });
        }
        // –ú–∞–ø–ø–∏–Ω–≥ —Ä—É—Å—Å–∫–∏—Ö –Ω–∞–∑–≤–∞–Ω–∏–π –±—Ä–µ–Ω–¥–æ–≤ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ (–≥–ª–æ–±–∞–ª—å–Ω–æ)
        const brandMapping = {
            '–ú–ê–ê–ì': 'MAAG',
            '–ú–êAG': 'MAAG',
            'MAAG': 'MAAG',
            '–≠–ö–†–Æ': 'ECRU',
            'ECRU': 'ECRU',
            '–î–ê–ë': 'DUB',
            'DAB': 'DUB',
            'DUB': 'DUB',
            '–í–ò–õ–ï–¢': 'VILET',
            'VILET': 'VILET',
            '12 STOREEZ': '12 STOREEZ',
            '12STOREEZ': '12 STOREEZ'
        };
        
        // –§—É–Ω–∫—Ü–∏—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–∞–∑–≤–∞–Ω–∏—è –±—Ä–µ–Ω–¥–∞ (–≥–ª–æ–±–∞–ª—å–Ω–æ)
        function normalizeBrand(brandName) {
            if (!brandName) return '';
            
            // –ë–µ—Ä—ë–º –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ –∏ –ø—Ä–∏–≤–æ–¥–∏–º –∫ –≤–µ—Ä—Ö–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
            const firstWord = brandName.toString().trim().split(/[\s\/]/)[0].toUpperCase();
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞–ø–ø–∏–Ω–≥
            return brandMapping[firstWord] || firstWord;
        }
        // –§—É–Ω–∫—Ü–∏—è –æ–±–æ–≥–∞—â–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
        function enrichWithSchedule(reportData, scheduleData) {
            
            // –°–æ–∑–¥–∞–µ–º Map –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞: –º–∞–≥–∞–∑–∏–Ω -> —Å–ø–∏—Å–æ–∫ –±—Ä–µ–Ω–¥–æ–≤ —Å –∏—Ö –¥–∞–Ω–Ω—ã–º–∏
            const scheduleMap = new Map();
            
            // –í—ã–≤–æ–¥–∏–º –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞)
            if (scheduleData.length > 0) {
                console.log('–ö–æ–ª–æ–Ω–∫–∏ –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏:', Object.keys(scheduleData[0]));
            }
            
            scheduleData.forEach(row => {
                const brand = normalizeBrand(row['–ë—Ä–µ–Ω–¥'] || '');
                const storeNumber = (row['–ù–æ–º–µ—Ä –º–∞–≥–∞–∑–∏–Ω–∞'] || '').toString().trim();
                
                if (!storeNumber || !brand) return;
                
                // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞–∑–≤–∞–Ω–∏–π –∫–æ–ª–æ–Ω–æ–∫
                const tc = row['–¢–¶'] || '';
                const brandOrder = row['–ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ –¢–¶'] || 
                                  row['–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ –¢–¶'] || 
                                  row['–ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ –¢–¶ '] || '';
                const internalOrder = row['–ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç –∫–∞–±–∏–Ω—ã'] || 
                                     row['–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç –∫–∞–±–∏–Ω—ã'] || 
                                     row['–ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç –∫–∞–±–∏–Ω—ã '] || '';
                
                // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –º–∞–≥–∞–∑–∏–Ω–∞, –µ—Å–ª–∏ –µ—ë –µ—â—ë –Ω–µ—Ç
                if (!scheduleMap.has(storeNumber)) {
                    scheduleMap.set(storeNumber, new Map());
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –±—Ä–µ–Ω–¥–∞ –≤ —ç—Ç–æ–º –º–∞–≥–∞–∑–∏–Ω–µ
                scheduleMap.get(storeNumber).set(brand, {
                    tc: tc,
                    brandOrder: brandOrder,
                    internalOrder: internalOrder
                });
                
                // –û—Ç–ª–∞–¥–∫–∞: –≤—ã–≤–æ–¥–∏–º –ø–µ—Ä–≤—ã–µ 5 –∑–∞–ø–∏—Å–µ–π
                if (scheduleMap.size <= 2 && scheduleMap.get(storeNumber).size <= 3) {
                    console.log(`–ú–∞–≥–∞–∑–∏–Ω: ${storeNumber}, –ë—Ä–µ–Ω–¥: ${brand}, –¢–¶: ${tc}, –ü–æ—Å–ª.–¢–¶: ${brandOrder}, –ü–æ—Å–ª.–∫–∞–±–∏–Ω–∞: ${internalOrder}`);
                }
            });
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç—á—ë—Ç–∞ –ø–æ –∫–ª—é—á–µ–≤—ã–º –ø–æ–ª—è–º –∏ —Å—á–∏—Ç–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–æ—Ä–æ–±—ã
            const groupedData = new Map();
            
            // –í—ã–≤–æ–¥–∏–º –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞)
            if (reportData.length > 0) {
                console.log('–ö–æ–ª–æ–Ω–∫–∏ –≤ –æ—Ç—á–µ—Ç–µ:', Object.keys(reportData[0]));
            }
            
            reportData.forEach(row => {
                const brand = (row['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '').toString().trim();
                const storeNumber = (row['–ù–æ–º–µ—Ä –º–∞–≥–∞–∑–∏–Ω–∞'] || '').toString().trim();
                const transport = row['–ù–æ–º–µ—Ä —Ä–µ–π—Å–∞'] || '';
                const mesto = row['–ú–µ—Å—Ç–æ'] || '';
                const korobNum = (row['–ö–æ—Ä–æ–±'] || '').toString().trim();
                
                // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏: —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç + –º–∞–≥–∞–∑–∏–Ω + –±—Ä–µ–Ω–¥ + –º–µ—Å—Ç–æ
                const groupKey = `${transport}_${storeNumber}_${brand}_${mesto}`;
                
                if (!groupedData.has(groupKey)) {
                    groupedData.set(groupKey, {
                        transport: transport,
                        storeNumber: storeNumber,
                        brand: brand,
                        mesto: mesto,
                        uniqueBoxes: new Set()
                    });
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–º–µ—Ä –∫–æ—Ä–æ–±–∞ –≤ Set –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö
                if (korobNum) {
                    groupedData.get(groupKey).uniqueBoxes.add(korobNum);
                }
            });
            
            // –û–±–æ–≥–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç—á—ë—Ç–∞
            const enrichedData = [];
            let foundCount = 0;
            let notFoundCount = 0;
            
            groupedData.forEach((groupInfo) => {
                // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –±—Ä–µ–Ω–¥ –∏–∑ –æ—Ç—á–µ—Ç–∞
                const normalizedBrand = normalizeBrand(groupInfo.brand);
                const storeNumber = groupInfo.storeNumber;
                
                // –ò—â–µ–º –º–∞–≥–∞–∑–∏–Ω –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏
                const storeSchedule = scheduleMap.get(storeNumber);
                let scheduleInfo = null;
                
                if (storeSchedule) {
                    // –ò—â–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –±—Ä–µ–Ω–¥–∞ –≤ —ç—Ç–æ–º –º–∞–≥–∞–∑–∏–Ω–µ
                    scheduleInfo = storeSchedule.get(normalizedBrand);
                    
                    if (scheduleInfo) {
                        foundCount++;
                        // –û—Ç–ª–∞–¥–∫–∞: –≤—ã–≤–æ–¥–∏–º –ø–µ—Ä–≤—ã–µ 2 –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
                        if (foundCount <= 2) {
                            console.log(`‚úì –ù–∞–π–¥–µ–Ω–æ: –ú–∞–≥–∞–∑–∏–Ω ${storeNumber}, –ë—Ä–µ–Ω–¥ ${normalizedBrand} ‚Üí –¢–¶: ${scheduleInfo.tc}, –ü–æ—Å–ª: ${scheduleInfo.brandOrder}/${scheduleInfo.internalOrder}`);
                        }
                    } else {
                        notFoundCount++;
                        // –û—Ç–ª–∞–¥–∫–∞: –≤—ã–≤–æ–¥–∏–º –ø–µ—Ä–≤—ã–µ 3 –Ω–µ–Ω–∞–π–¥–µ–Ω–Ω—ã—Ö
                        if (notFoundCount <= 3) {
                            console.log(`‚úó –ù–µ –Ω–∞–π–¥–µ–Ω–æ: –ú–∞–≥–∞–∑–∏–Ω ${storeNumber}, –ë—Ä–µ–Ω–¥ ${normalizedBrand} (–∏–∑ –æ—Ç—á–µ—Ç–∞: "${groupInfo.brand}")`);
                            console.log(`  –î–æ—Å—Ç—É–ø–Ω—ã–µ –±—Ä–µ–Ω–¥—ã –≤ –º–∞–≥–∞–∑–∏–Ω–µ ${storeNumber}:`, Array.from(storeSchedule.keys()));
                        }
                    }
                } else {
                    notFoundCount++;
                    if (notFoundCount <= 3) {
                        console.log(`‚úó –ú–∞–≥–∞–∑–∏–Ω ${storeNumber} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏`);
                        console.log(`  –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–∞–≥–∞–∑–∏–Ω—ã (–ø–µ—Ä–≤—ã–µ 5):`, Array.from(scheduleMap.keys()).slice(0, 5));
                    }
                }
                
                const finalScheduleInfo = scheduleInfo || {
                    tc: '',
                    brandOrder: '',
                    internalOrder: ''
                };
                
                enrichedData.push({
                    '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç/‚Ññ –∑–∞–∫–∞–∑–∞': groupInfo.transport,
                    '‚Ññ –º–∞–≥–∞–∑–∏–Ω–∞': groupInfo.storeNumber,
                    '–ë—Ä–µ–Ω–¥': normalizedBrand,
                    '–¢–¶': finalScheduleInfo.tc,
                    '–ë—Ä–µ–Ω–¥/–¢–¶': finalScheduleInfo.tc ? `${normalizedBrand} / ${finalScheduleInfo.tc}` : normalizedBrand,
                    '–ú–µ—Å—Ç–æ': groupInfo.mesto,
                    '–ö–æ–ª-–≤–æ –∫–æ—Ä': groupInfo.uniqueBoxes.size,
                    '–ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –ë—Ä–µ–Ω–¥–∞ –≤ –¢–°': finalScheduleInfo.brandOrder,
                    '–ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –≤–Ω—É—Ç—Ä–∏ –ë—Ä–µ–Ω–¥–∞': finalScheduleInfo.internalOrder,
                    '–ö–æ–º–º–µ–Ω—Ç.': ''
                });
            });
            
            console.log(`–ò—Ç–æ–≥–æ: –Ω–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π: ${foundCount}, –Ω–µ –Ω–∞–π–¥–µ–Ω–æ: ${notFoundCount}`);
            
            return enrichedData;
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è POSM —Å—Ç—Ä–æ–∫
        function addPOSMRows(data, posmData) {
            if (!posmData || posmData.length === 0) {
                return data;
            }
            
            // –°–æ–∑–¥–∞–µ–º Map –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ POSM –ø–æ –∫–ª—é—á—É (–º–∞–≥–∞–∑–∏–Ω -> –±—Ä–µ–Ω–¥ -> —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫)
            const posmMap = new Map();
            
            posmData.forEach(row => {
                const brand = normalizeBrand(row['–ë—Ä–µ–Ω–¥'] || '');
                const storeNumber = (row['–º–∞–≥–∞–∑–∏–Ω'] || '').toString().trim();
                
                if (!storeNumber || !brand) return;
                
                // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –º–∞–≥–∞–∑–∏–Ω–∞, –µ—Å–ª–∏ –µ—ë –µ—â—ë –Ω–µ—Ç
                if (!posmMap.has(storeNumber)) {
                    posmMap.set(storeNumber, new Map());
                }
                
                if (!posmMap.get(storeNumber).has(brand)) {
                    posmMap.get(storeNumber).set(brand, []);
                }
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                const name = (row['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ'] || '').toString().toLowerCase();
                let comment = '–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ';
                if (name.includes('—Ç—Ä–∞–Ω—Å—Ñ–µ—Ä')) {
                    comment = '—Ç—Ä–∞–Ω—Å—Ñ–µ—Ä';
                } else if (name.includes('posm')) {
                    comment = 'POSM';
                }
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è "–ú–µ—Å—Ç–æ"
                const size = (row['–†–∞–∑–º–µ—Ä'] || '').toString().trim();
                const weight = (row['–í–µ—Å'] || '').toString().trim();
                const mesto = size && weight ? `${size} ${weight}` : (size || weight || '');
                
                posmMap.get(storeNumber).get(brand).push({
                    '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç/‚Ññ –∑–∞–∫–∞–∑–∞': row['–†–µ–π—Å'] || '',
                    '‚Ññ –º–∞–≥–∞–∑–∏–Ω–∞': storeNumber,
                    '–ë—Ä–µ–Ω–¥': brand,
                    '–¢–¶': '',
                    '–ë—Ä–µ–Ω–¥/–¢–¶': '',
                    '–ú–µ—Å—Ç–æ': mesto,
                    '–ö–æ–ª-–≤–æ –∫–æ—Ä': row['–ö–æ–ª-–≤–æ'] || '',
                    '–ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –ë—Ä–µ–Ω–¥–∞ –≤ –¢–°': '',
                    '–ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –≤–Ω—É—Ç—Ä–∏ –ë—Ä–µ–Ω–¥–∞': '',
                    '–ö–æ–º–º–µ–Ω—Ç.': comment
                });
            });
            
            // –í—Å—Ç–∞–≤–ª—è–µ–º POSM —Å—Ç—Ä–æ–∫–∏ –ø–æ—Å–ª–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å—Ç—Ä–æ–∫
            const result = [];
            
            data.forEach(row => {
                // –î–æ–±–∞–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Å—Ç—Ä–æ–∫—É
                result.push(row);
                
                // –ò—â–µ–º POSM —Å—Ç—Ä–æ–∫–∏ –¥–ª—è —ç—Ç–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞ –∏ –±—Ä–µ–Ω–¥–∞
                const brand = row['–ë—Ä–µ–Ω–¥'];
                const storeNumber = row['‚Ññ –º–∞–≥–∞–∑–∏–Ω–∞'].toString();
                
                const storePOSM = posmMap.get(storeNumber);
                
                if (storePOSM) {
                    const brandPOSM = storePOSM.get(brand);
                    
                    if (brandPOSM) {
                        brandPOSM.forEach(posmRow => {
                            // –ù–∞—Å–ª–µ–¥—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏ –ë—Ä–µ–Ω–¥/–¢–¶ –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
                            posmRow['–ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –ë—Ä–µ–Ω–¥–∞ –≤ –¢–°'] = row['–ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –ë—Ä–µ–Ω–¥–∞ –≤ –¢–°'];
                            posmRow['–ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –≤–Ω—É—Ç—Ä–∏ –ë—Ä–µ–Ω–¥–∞'] = row['–ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –≤–Ω—É—Ç—Ä–∏ –ë—Ä–µ–Ω–¥–∞'];
                            posmRow['–ë—Ä–µ–Ω–¥/–¢–¶'] = row['–ë—Ä–µ–Ω–¥/–¢–¶'];
                            result.push(posmRow);
                        });
                        // –£–¥–∞–ª—è–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ POSM —Å—Ç—Ä–æ–∫–∏
                        storePOSM.delete(brand);
                    }
                }
            });
            
            return result;
        }
        // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        function sortFinalData(data) {
            const commentOrder = {
                '': 0,
                '—Ç—Ä–∞–Ω—Å—Ñ–µ—Ä': 1,
                'POSM': 2,
                '–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ': 3
            };
            
            return data.sort((a, b) => {
                // –£—Ä–æ–≤–µ–Ω—å 1: –ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –ë—Ä–µ–Ω–¥–∞ –≤ –¢–°
                const brandOrderA = parseFloat(a['–ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –ë—Ä–µ–Ω–¥–∞ –≤ –¢–°']) || 999999;
                const brandOrderB = parseFloat(b['–ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –ë—Ä–µ–Ω–¥–∞ –≤ –¢–°']) || 999999;
                if (brandOrderA !== brandOrderB) {
                    return brandOrderA - brandOrderB;
                }
                
                // –£—Ä–æ–≤–µ–Ω—å 2: –ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –≤–Ω—É—Ç—Ä–∏ –ë—Ä–µ–Ω–¥–∞
                const internalOrderA = parseFloat(a['–ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –≤–Ω—É—Ç—Ä–∏ –ë—Ä–µ–Ω–¥–∞']) || 999999;
                const internalOrderB = parseFloat(b['–ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –≤–Ω—É—Ç—Ä–∏ –ë—Ä–µ–Ω–¥–∞']) || 999999;
                if (internalOrderA !== internalOrderB) {
                    return internalOrderA - internalOrderB;
                }
                
                // –£—Ä–æ–≤–µ–Ω—å 3: ‚Ññ –º–∞–≥–∞–∑–∏–Ω–∞
                const storeA = parseInt(a['‚Ññ –º–∞–≥–∞–∑–∏–Ω–∞']) || 0;
                const storeB = parseInt(b['‚Ññ –º–∞–≥–∞–∑–∏–Ω–∞']) || 0;
                if (storeA !== storeB) {
                    return storeA - storeB;
                }
                
                // –£—Ä–æ–≤–µ–Ω—å 4: –ü–æ —Ç–∏–ø—É –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è (–ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –ª–∏ –ë—Ä–µ–Ω–¥/–¢–¶)
                if (a['–ë—Ä–µ–Ω–¥/–¢–¶'] === b['–ë—Ä–µ–Ω–¥/–¢–¶']) {
                    const commentA = commentOrder[a['–ö–æ–º–º–µ–Ω—Ç.']] !== undefined ? commentOrder[a['–ö–æ–º–º–µ–Ω—Ç.']] : 999;
                    const commentB = commentOrder[b['–ö–æ–º–º–µ–Ω—Ç.']] !== undefined ? commentOrder[b['–ö–æ–º–º–µ–Ω—Ç.']] : 999;
                    return commentA - commentB;
                }
                
                return 0;
            });
        }
        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
        function displayTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            data.forEach(row => {
                const tr = document.createElement('tr');
                
                // –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç/‚Ññ –∑–∞–∫–∞–∑–∞
                const td1 = document.createElement('td');
                td1.textContent = row['–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç/‚Ññ –∑–∞–∫–∞–∑–∞'];
                tr.appendChild(td1);
                
                // ‚Ññ –º–∞–≥–∞–∑–∏–Ω–∞
                const td2 = document.createElement('td');
                td2.textContent = row['‚Ññ –º–∞–≥–∞–∑–∏–Ω–∞'];
                td2.className = 'text-right';
                tr.appendChild(td2);
                
                // –ë—Ä–µ–Ω–¥/–¢–¶
                const td3 = document.createElement('td');
                td3.textContent = row['–ë—Ä–µ–Ω–¥/–¢–¶'];
                tr.appendChild(td3);
                
                // –ú–µ—Å—Ç–æ
                const td4 = document.createElement('td');
                td4.textContent = row['–ú–µ—Å—Ç–æ'];
                tr.appendChild(td4);
                
                // –ö–æ–ª-–≤–æ –∫–æ—Ä
                const td5 = document.createElement('td');
                td5.textContent = row['–ö–æ–ª-–≤–æ –∫–æ—Ä'];
                td5.className = 'text-right';
                tr.appendChild(td5);
                
                // –ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –ë—Ä–µ–Ω–¥–∞ –≤ –¢–°
                const td6 = document.createElement('td');
                td6.textContent = row['–ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –ë—Ä–µ–Ω–¥–∞ –≤ –¢–°'];
                td6.className = 'text-right';
                tr.appendChild(td6);
                
                // –ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –≤–Ω—É—Ç—Ä–∏ –ë—Ä–µ–Ω–¥–∞
                const td7 = document.createElement('td');
                td7.textContent = row['–ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –≤–Ω—É—Ç—Ä–∏ –ë—Ä–µ–Ω–¥–∞'];
                td7.className = 'text-right';
                tr.appendChild(td7);
                
                // –ö–æ–º–º–µ–Ω—Ç.
                const td8 = document.createElement('td');
                td8.textContent = row['–ö–æ–º–º–µ–Ω—Ç.'];
                tr.appendChild(td8);
                
                tbody.appendChild(tr);
            });
            
            document.getElementById('tableContainer').classList.remove('hidden');
            document.getElementById('downloadBtn').style.display = 'inline-block';
        }
        // –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Excel
        function exportToExcel() {
            // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
            const exportData = processedData.map(row => ({
                '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç/‚Ññ –∑–∞–∫–∞–∑–∞': row['–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç/‚Ññ –∑–∞–∫–∞–∑–∞'],
                '‚Ññ –º–∞–≥–∞–∑–∏–Ω–∞': row['‚Ññ –º–∞–≥–∞–∑–∏–Ω–∞'],
                '–ë—Ä–µ–Ω–¥/–¢–¶': row['–ë—Ä–µ–Ω–¥/–¢–¶'],
                '–ú–µ—Å—Ç–æ': row['–ú–µ—Å—Ç–æ'],
                '–ö–æ–ª-–≤–æ –∫–æ—Ä': row['–ö–æ–ª-–≤–æ –∫–æ—Ä'],
                '–ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –ë—Ä–µ–Ω–¥–∞ –≤ –¢–°': row['–ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –ë—Ä–µ–Ω–¥–∞ –≤ –¢–°'],
                '–ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –≤–Ω—É—Ç—Ä–∏ –ë—Ä–µ–Ω–¥–∞': row['–ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –≤–Ω—É—Ç—Ä–∏ –ë—Ä–µ–Ω–¥–∞'],
                '–ö–æ–º–º–µ–Ω—Ç.': row['–ö–æ–º–º–µ–Ω—Ç.']
            }));
            
            // –°–æ–∑–¥–∞–µ–º workbook –∏ worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(exportData);
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –∫–æ–ª–æ–Ω–æ–∫
            ws['!cols'] = [
                { wch: 25 }, // –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç/‚Ññ –∑–∞–∫–∞–∑–∞
                { wch: 12 }, // ‚Ññ –º–∞–≥–∞–∑–∏–Ω–∞
                { wch: 20 }, // –ë—Ä–µ–Ω–¥/–¢–¶
                { wch: 20 }, // –ú–µ—Å—Ç–æ
                { wch: 12 }, // –ö–æ–ª-–≤–æ –∫–æ—Ä
                { wch: 22 }, // –ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –ë—Ä–µ–Ω–¥–∞ –≤ –¢–°
                { wch: 22 }, // –ü–æ—Å–ª–µ–¥–æ–≤-—Ç—å –≤–Ω—É—Ç—Ä–∏ –ë—Ä–µ–Ω–¥–∞
                { wch: 15 }  // –ö–æ–º–º–µ–Ω—Ç.
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, '–†–µ–∑—É–ª—å—Ç–∞—Ç');
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ–∞–π–ª
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/octet-stream' });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
            saveAs(blob, 'result.xlsx');
        }
        // –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
        async function processFiles() {
            try {
                // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ —Ç–∞–±–ª–∏—Ü—É
                document.getElementById('errorMessage').classList.add('hidden');
                document.getElementById('successMessage').classList.add('hidden');
                document.getElementById('tableContainer').classList.add('hidden');
                document.getElementById('downloadBtn').style.display = 'none';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                document.getElementById('loadingMessage').classList.remove('hidden');
                
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª—ã
                const reportData = await readExcelFile(reportFileData);
                const scheduleData = await readExcelFile(scheduleFileData);
                let posmData = null;
                
                if (posmFileData) {
                    posmData = await readExcelFile(posmFileData);
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö
                if (!reportData || reportData.length === 0) {
                    throw new Error('–§–∞–π–ª –æ—Ç—á—ë—Ç–∞ –ø—É—Å—Ç –∏–ª–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö');
                }
                
                if (!scheduleData || scheduleData.length === 0) {
                    throw new Error('–§–∞–π–ª —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –ø—É—Å—Ç –∏–ª–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö');
                }
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
                const filteredReport = filterReport(reportData);
                const filteredSchedule = filterSchedule(scheduleData);
                
                if (filteredReport.length === 0) {
                    throw new Error('–ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö');
                }
                
                // –û–±–æ–≥–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
                let enrichedData = enrichWithSchedule(filteredReport, filteredSchedule);
                
                // –î–æ–±–∞–≤–ª—è–µ–º POSM —Å—Ç—Ä–æ–∫–∏
                if (posmData && posmData.length > 0) {
                    enrichedData = addPOSMRows(enrichedData, posmData);
                }
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
                processedData = sortFinalData(enrichedData);
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                document.getElementById('loadingMessage').classList.add('hidden');
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
                displayTable(processedData);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                const successMsg = document.getElementById('successMessage');
                successMsg.textContent = `‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${processedData.length} —Å—Ç—Ä–æ–∫`;
                successMsg.classList.remove('hidden');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ:', error);
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                document.getElementById('loadingMessage').classList.add('hidden');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                const errorMsg = document.getElementById('errorMessage');
                errorMsg.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                errorMsg.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>